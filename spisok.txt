Отчёт по проекту Veldspar (Rust + wgpu)
Дата анализа: 2026-02-09
Основа оценки: полный просмотр исходников крейтов, шейдеров и ассетов + проверка сборки `cargo check`.

1. Что ГОТОВО (реализовано и работает)

1.1. Общая архитектура и сборка
1. Проект оформлен как workspace с разделением на крейты: `veldspar_client`, `veldspar_server`, `veldspar_shared`, `veldspar_core`, `veldspar_persist`.
2. Сборка проходит (`cargo check` успешен), бинарники клиента и сервера компилируются.
3. Есть разделение ответственности: общий протокол/данные (`shared`), клиент, сервер, хранение мира, инфраструктурные утилиты.

1.2. `veldspar_shared`
1. Реализован реестр блоков (`BlockRegistry`) с дефолтным набором блоков и стабильными ID.
2. Реализованы координатные преобразования мира/чанка (`world_to_chunk`, `chunk_to_world`, индексация блока в чанке).
3. Реализован формат чанка (`ChunkData`) с корректной (де)сериализацией фиксированного объёма.
4. Реализована базовая физика трассировки луча по вокселям (`raycast_blocks`) для выбора блока.
5. Реализована базовая инвентарная модель (item/stack/inventory, стакование, swap, add/remove).
6. Реализовано внутричанковое освещение: вертикальный солнечный проход + распространение света внутри чанка.
7. Реализован сетевой протокол C2S/S2C и сериализация через bincode.
8. Реализован procedural worldgen:
9. Высоты через Perlin noise.
10. Несколько биомов.
11. Слои пород/поверхности по биомам.
12. Пещеры (3D noise).
13. Руды (depth-based + blob-like).
14. Вода до уровня моря.
15. Деревья/кактусы/декор (трава/цветы).

1.3. `veldspar_persist`
1. Реализовано сжатие/распаковка (Zstd и LZ4 API).
2. Реализован регионный формат `.vsr`:
3. Магическая сигнатура `VSPR`.
4. Wire-версия (несжатый/сжатый Zstd).
5. Чтение, запись, flush, выдача списка чанков региона.
6. Есть базовая обратная совместимость со старым вариантом без байта wire-version.

1.4. `veldspar_server`
1. Серверный цикл тиков (20 TPS), корректная остановка по Ctrl+C с сохранением мира.
2. UDP-сеть на Renet с двумя каналами (reliable ordered / unreliable).
3. Поддержка многопользовательских подключений, выдача `player_id`, рассылка join/leave.
4. Обработка handshake/chunk request/block edit/player input/chat/disconnect.
5. Выдача чанков клиентам и broadcast подтверждённых правок блоков.
6. Серверный мир:
7. Ленивое получение/генерация чанков.
8. Загрузка из persistence.
9. Маркировка dirty-чанков и сохранение.
10. Проверка валидности ID блока перед применением редактирования.
11. Периодический и финальный flush мира.

1.5. `veldspar_client` — игровой цикл и геймплей
1. Полноценный desktop-клиент на `winit` с event loop и рендер-циклом.
2. Главное меню (Singleplayer/Multiplayer/Quit) с keyboard/mouse hit-test.
3. Режимы игры:
4. Singleplayer: локальная генерация + загрузка/сохранение.
5. Multiplayer: подключение к серверу и обмен протокольными сообщениями.
6. Управление камерой и персонажем (мышь, WASD, прыжок, гравитация, коллизии, спринт, fly-mode).
7. Стриминг чанков вокруг игрока с ограничением дальности и выгрузкой удалённых чанков.
8. Асинхронная генерация чанков в отдельном потоке + отдельный mesh worker pool.
9. Реализованы постановка/ломание блоков с лучом, прогрессом ломания и ремешем соседей.
10. Реализован выбор блока (hotbar 1..9) и синхронизация правок с сервером в мультиплеере.
11. Реализованы автосейв и сохранение метаданных мира (`world.toml`: seed, позиция, yaw/pitch, время).
12. Приём и отрисовка удалённых игроков (позиция/yaw + анимационная фаза шага).

1.6. `veldspar_client` — рендер и UI
1. Инициализация wgpu (surface/device/pipelines/bind groups/depth).
2. Атлас текстур блоков собирается на старте из `assets/textures/blocks`.
3. Рендер чанков разделён на opaque и water пайплайны.
4. Есть greedy meshing + AO + базовый light term + тинирование травы/листвы по биому.
5. Есть frustum culling чанков.
6. Есть fade-in чанков после загрузки.
7. Есть sky renderer (градиент день/ночь + звёзды).
8. Есть cloud renderer (процедурные облака).
9. Есть water shader с волнами/спекуляром/прозрачностью.
10. Есть block highlight (проволочная рамка выбранного блока).
11. Есть break overlay (визуал прогресса ломания).
12. Есть crosshair.
13. Есть hotbar.
14. Есть main menu renderer.
15. Есть first-person hand + простая анимация атаки.
16. Есть debug overlay в заголовке окна (позиция/FPS/режим/направление/блок).

1.7. Шейдеры и ассеты
1. Набор шейдеров для всех основных этапов рендера присутствует:
2. `chunk_opaque.wgsl`, `chunk_water.wgsl`, `sky.wgsl`, `clouds.wgsl`, `player.wgsl`, `highlight.wgsl`, `break_overlay.wgsl`, `hotbar.wgsl`, `main_menu.wgsl`, `ui.wgsl`.
3. Блоковые текстуры в `assets/textures/blocks` присутствуют и покрывают зарегистрированные блоки.
4. Наличие дополнительных генераторов контента: `tools/texture_forge`, `tools/generate_new_block_textures.py`.
5. Есть служебные утилиты для региона и атласа (`region_inspector`, `atlas_packer`).

1.8. `veldspar_core`
1. Реализованы базовые строительные блоки инфраструктуры:
2. event-channel (обёртка над std mpsc).
3. job system на rayon thread pool.

2. Что ОСТАЛОСЬ ДОДЕЛАТЬ (не реализовано или частично)

2.1. Критичные функциональные пробелы
1. Нет полноценных миграций формата persistence: `migrate_region_payload` сейчас возвращает ошибку для любой версии, кроме текущей.
2. Протокольные сообщения определены, но не интегрированы end-to-end:
3. `S2C::HandshakeReject` не отправляется сервером.
4. `S2C::ChunkUnload` не используется.
5. `S2C::ChunkDelta` не используется.
6. `S2C::TimeSync` не используется.
7. `S2C::Chat` сервер шлёт, но клиент в `app.rs` фактически не обрабатывает (чата в UI нет).
8. Нет серверной валидации handshake (версия протокола/имя игрока), сейчас по сути auto-accept.
9. Нет авторизации/аутентификации/шифрования, нет античита и серверного контроля допустимых действий игрока.
10. На сервере не используется `username` из handshake (имя игрока сейчас формируется как `Player{id}`).

2.2. `veldspar_server` — незавершённые подсистемы
1. `chunk_manager.rs` не используется (мертвый код).
2. `commands.rs` не подключён к runtime (нет консольных команд в рабочем серверном цикле).
3. Сервер поддерживает только очень базовую синхронизацию:
4. Нет репликации инвентаря, здоровья, эффектов, сущностей/мобов.
5. Нет серверной физики/коррекции движения клиента.
6. Нет системы прав/привилегий/админ-команд.
7. Нет механики разгрузки чанков по активности игроков.

2.3. `veldspar_client` — незавершённый геймплей
1. Инвентарь из `shared::inventory` не подключён к геймплею/интерфейсу.
2. Нет крафта, предметов в мире, контейнеров, подбора лута.
3. Нет HUD чата, таб-листа, системных уведомлений.
4. Нет паузы/настроек/переназначения клавиш/опций графики.
5. Нет звука/музыки.
6. Нет эффектов урона, здоровья, смерти/респавна.
7. Локальное подтверждение block edit в мультиплеере оптимистичное, отката состояния по reject фактически нет (reject не обрабатывается клиентом).
8. Нет нормального UX ввода IP (буфер обмена, валидация, история, подсказки).

2.4. `veldspar_client` — рендер/визуал (частично)
1. `renderer/particles.rs` и `assets/shaders/particles.wgsl` реализованы, но не подключены в основной `Renderer` (подсистема частиц фактически не работает в игре).
2. `renderer/ui.rs` — заглушка, не используется.
3. `renderer/mod.rs.backup` — старый дублирующий файл, не участвует в сборке (технический долг).
4. У удалённого игрока `pitch` приходит, но в модели/анимации не используется.
5. Нет пост-эффектов (SSAO, bloom, TAA/FXAA, tone mapping), нет гибкой настройки качества.
6. Нет теней от солнца/динамических источников света.
7. Освещение только внутри чанка, межчанковая световая согласованность не реализована.

2.5. `veldspar_shared` — частично реализованные модели
1. `AABB` в physics объявлен, но реальных AABB-тестов/системы столкновений на его базе нет.
2. `PlayerInputFlags` объявлены, но по коду практически не задействованы как полноценный контракт между клиентом и сервером.
3. Инвентарь есть на уровне модели, но отсутствуют сетевые сообщения и серверная логика для него.
4. Блоки используют упрощённые свойства; нет развитой системы block states, жидкостей с течением, редстоуна, интерактивных блоков.

2.6. `veldspar_core`
1. `bevy_ecs` в зависимостях, но ECS-подход фактически не применён в текущей архитектуре.
2. Модули core пока играют роль утилит, а не центра общей инфраструктуры проекта.

2.7. Ассеты и контент
1. Часть текстур в `assets/textures/blocks` сейчас не используется напрямую в атласе (например, отдельные side/end варианты — используется упрощённое сопоставление).
2. Папка `textures_for_claude/` огромная, но в runtime кодом не подключена (референсный/внешний набор, потенциально лишний вес репозитория).
3. Нет формальной системы манифестов ассетов (версионирование, зависимости, hot-reload).

2.8. Инструменты и качество проекта
1. `tools/atlas_packer` сейчас фактически stub (проверяет загрузку, но не собирает полноценный production-атлас).
2. `docs/` практически пустой (нет архитектурной документации, сетевого протокола, runbook’ов).
3. Нет автоматических тестов (unit/integration/e2e) по ключевым подсистемам.
4. Нет CI-конвейера с проверкой формата/линта/тестов.
5. Много предупреждений dead code в `cargo check`, что подтверждает незавершённые или отложенные куски функционала.

3. Краткий вывод
1. Базовый вертикальный срез «играбельного voxel-прототипа» уже сделан: генерация мира, рендер, управление, singleplayer, базовый multiplayer, сохранение.
2. Проект ещё не доведён до состояния полнофункциональной игры/production-сервера: не завершены протокол и UI-системы, нет тестов, нет развитой серверной логики и части геймплейных подсистем.
